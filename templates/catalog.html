<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tienda Online TemucoSoft</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="/shop/">üè™ TemucoSoft Store</a>
            <button class="btn btn-warning" onclick="checkout()">
                üõí Ver Carrito (<span id="cart-count">0</span>)
            </button>
        </div>
    </nav>

    <div class="container">
        <h2 class="text-center mb-4">Nuestros Productos</h2>
        <div class="row" id="product-grid">
            </div>
    </div>

    <div class="modal fade" id="cartModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">Tu Carrito</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="list-group mb-3" id="cart-items"></ul>
                    <div class="mb-3">
                        <label>Nombre Cliente:</label>
                        <input type="text" id="guest-name" class="form-control" placeholder="Juan P√©rez">
                    </div>
                    <div class="mb-3">
                        <label>Email:</label>
                        <input type="email" id="guest-email" class="form-control" placeholder="juan@email.com">
                    </div>
                    <h3 class="text-end">Total: $<span id="cart-total">0</span></h3>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Seguir comprando</button>
                    <button type="button" class="btn btn-primary" onclick="submitOrder()">Confirmar Pedido</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let cart = [];
        
        // 1. Cargar Productos P√∫blicos
        async function loadProducts() {
            const imgHtml = p.image 
                    ? `<img src="${p.image}" class="card-img-top p-3" alt="${p.name}" style="height: 200px; object-fit: contain;">`
                    : `<div class="d-flex align-items-center justify-content-center bg-light" style="height: 200px;">
                         <span class="display-4 text-muted">üì¶</span>
                       </div>`;

                container.innerHTML += `
                    <div class="col-md-3 mb-4">
                        <div class="card h-100 shadow-sm border-0 hover-card">
                            ${imgHtml}
                            <div class="card-body text-center">
                                <h5 class="fw-bold text-dark">${p.name}</h5>
                                <p class="text-muted small">${p.sku}</p>
                                <h4 class="text-primary fw-bold">$${p.price}</h4>
                                <button class="btn btn-primary btn-custom btn-sm mt-2 w-100" 
                                    onclick="addToCart(${p.id}, '${p.name}', ${p.price})">
                                    <i class="bi bi-cart-plus"></i> Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            };

        // 2. L√≥gica de Carrito
        function addToCart(id, name, price) {
            cart.push({ product: id, name: name, price: price, quantity: 1 });
            updateCartUI();
        }

        function updateCartUI() {
            document.getElementById('cart-count').innerText = cart.length;
        }

        function checkout() {
            const list = document.getElementById('cart-items');
            let total = 0;
            list.innerHTML = '';
            
            cart.forEach(item => {
                total += item.price;
                list.innerHTML += `<li class="list-group-item">${item.name} - $${item.price}</li>`;
            });
            
            document.getElementById('cart-total').innerText = total;
            new bootstrap.Modal(document.getElementById('cartModal')).show();
        }

        // 3. Enviar Pedido a API
        async function submitOrder() {
            const name = document.getElementById('guest-name').value;
            const email = document.getElementById('guest-email').value;
            
            if(!name || !email) return alert("Completa tus datos");

            const payload = {
                guest_name: name,
                guest_email: email,
                items: cart.map(c => ({ product: c.product, quantity: c.quantity }))
            };

            try {
                const res = await fetch('/api/orders/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if(res.ok) {
                    alert("‚úÖ ¬°Pedido enviado! Te contactaremos.");
                    cart = [];
                    window.location.reload();
                } else {
                    alert("Error al enviar pedido");
                }
            } catch(e) { console.error(e); }
        }

        loadProducts();
    </script>
</body>
</html>